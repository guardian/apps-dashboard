var CrittercismClient = require('../lib/CrittercismClient.js');
var Util = require('../lib/Util.js');
var moment = require ('moment');
var _ = require ('lodash');
var nconf = require('nconf');
var fs = require('fs');
var GuardianApp = require('../lib/GuardianApp.js');
var sleep = require('sleep');
var async = require('async');

nconf.file({ file: '../config.json' });
var username = nconf.get('crittercism_username');
var password = nconf.get('crittercism_password');
var clientid = nconf.get('crittercism_clientid');
console.log('username is ' + username);
console.log('clientid is ' + clientid);

function crashAsHtml(c){
	return `<a href='https://app.crittercism.com/developers/crash-details/5457bc14d478bc2b14000002/${c.hash}' target='_blank'>${c.name}</a><BR>${Util.abreviated(c.reason)}<BR>${c.uniqueSessionCount} users, ${c.sessionCount} crashes<BR><BR>`;
}

generateText(function(err, appVersion, majorVersion, newCrashes, newMajorVersionCrashes) {
	if(err) {
		console.log(JSON.stringify(err.message))
		throw err;
	}

	var newCrashesAsText = newCrashes.map(c => crashAsHtml(c)).join("");
	var newMajorVersionCrashesAsText = newMajorVersionCrashes.map(c => crashAsHtml(c)).join("");

	var js = `
$("#newCrashes").html("<b>${newCrashes.length} new crashes in ${appVersion}</b>:<BR>${newCrashesAsText}");
$("#newCrashesMajorVersion").html("<b>${newMajorVersionCrashes.length} new crashes in ${majorVersion}</b>:<BR>${newMajorVersionCrashesAsText}");`;

	var filename = "crashNew.js"
	console.log(js);
	fs.writeFile(filename, js, function(err) {
		if(err) {
			throw err;
		}

		console.log(filename + " was saved!");
	}); 
});

 
function generateText(callback) {
	var appVersion = GuardianApp.getLatestAndroidAppVersion();
	var majorVersion = "4.5"
	var cc = new CrittercismClient(clientid);

	//cc.init(username, password, function(err) {
	//	if (err) {
	//		callback(err);
	//	}

		console.log('Crittercism API client initialized');
	//	cc.topCrashByUser(appVersion, function(err, crashes){
	//		if (err) {
	//			callback(err);
	//		}

			//console.log(JSON.stringify(crashes));
	//		var crashes = [{"status":"unresolved","displayReason":null,"hash":"5d223303bcaff6eb","firstOccurred":"2016-07-07T12:15:26+00:00","lastOccurred":"2016-07-07T12:15:26+00:00","sessionCount":1,"reason":"Unable to add window -- token android.os.BinderProxy@3b12f9c is not valid; is your activity running?","name":"android.view.WindowManager$BadTokenException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":null},{"status":"unresolved","displayReason":null,"hash":"2989b8d11e9a6583","firstOccurred":"2016-07-07T12:32:41+00:00","lastOccurred":"2016-07-07T12:32:41+00:00","sessionCount":1,"reason":"","name":"java.lang.OutOfMemoryError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.squareup.picasso.BitmapHunter.decodeStream(BitmapHunter.java:142)"},{"status":"unresolved","displayReason":null,"hash":"8eb87267261f5c1f","firstOccurred":"2016-07-07T12:44:21+00:00","lastOccurred":"2016-07-07T12:44:21+00:00","sessionCount":1,"reason":"","name":"java.lang.OutOfMemoryError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.google.android.exoplayer.upstream.DefaultAllocator.allocate(DefaultAllocator.java:79)"},{"status":"unresolved","displayReason":null,"hash":"6c591454d6ba4eba","firstOccurred":"2016-07-07T12:00:18+00:00","lastOccurred":"2016-07-07T12:46:51+00:00","sessionCount":4,"reason":"unrecognized token: \"'/cgi-bin/login+cmd=login&mac=8c:3a:e3:17:a7:0c&ip=192.167.1.212&essid=KDU-Guest\" (code 1): , while compiling: selec...","name":"android.database.sqlite.SQLiteException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.guardian.http.cache.CacheJournalDbHelper.getEntry(CacheJournalDbHelper.java:82)"},{"status":"unresolved","displayReason":null,"hash":"575bf866f45e0e66","firstOccurred":"2016-07-07T12:57:18+00:00","lastOccurred":"2016-07-07T12:57:18+00:00","sessionCount":1,"reason":"GoogleApiClient must not be null","name":"java.lang.NullPointerException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.google.android.gms.common.internal.zzaa.zzb(Unknown Source)"},{"status":"unresolved","displayReason":null,"hash":"63f6afe38261bf05","firstOccurred":"2016-07-07T13:13:00+00:00","lastOccurred":"2016-07-07T13:13:00+00:00","sessionCount":1,"reason":"","name":"java.lang.NoSuchFieldException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"rx.schedulers.CachedThreadScheduler.createWorker(CachedThreadScheduler.java:107)"},{"status":"unresolved","displayReason":null,"hash":"6ca1a4aa6100adc2","firstOccurred":"2016-07-07T13:19:35+00:00","lastOccurred":"2016-07-07T13:19:35+00:00","sessionCount":1,"reason":"","name":"java.lang.OutOfMemoryError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.google.android.exoplayer.upstream.DefaultAllocator.allocate(DefaultAllocator.java:79)"},{"status":"unresolved","displayReason":null,"hash":"f20832387ff7390d","firstOccurred":"2016-07-07T13:23:19+00:00","lastOccurred":"2016-07-07T13:23:19+00:00","sessionCount":1,"reason":"Fatal Exception thrown on Scheduler.Worker thread.","name":"java.lang.OutOfMemoryError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:54)"},{"status":"unresolved","displayReason":null,"hash":"39346673ec3e3301","firstOccurred":"2016-07-07T13:27:37+00:00","lastOccurred":"2016-07-07T13:27:37+00:00","sessionCount":1,"reason":"The content of the adapter has changed but ListView did not receive a notification. Make sure the content of your adapter is not modified...","name":"java.lang.IllegalStateException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":null}]
		//	crashes = [{"status":"unresolved","displayReason":null,"hash":"5d223303bcaff6eb","firstOccurred":"2016-07-07T12:15:26+00:00","lastOccurred":"2016-07-07T12:15:26+00:00","sessionCount":1,"reason":"Unable to add window -- token android.os.BinderProxy@3b12f9c is not valid; is your activity running?","name":"android.view.WindowManager$BadTokenException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":null},{"status":"unresolved","displayReason":null,"hash":"2989b8d11e9a6583","firstOccurred":"2016-07-07T12:32:41+00:00","lastOccurred":"2016-07-07T12:32:41+00:00","sessionCount":1,"reason":"","name":"java.lang.OutOfMemoryError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.squareup.picasso.BitmapHunter.decodeStream(BitmapHunter.java:142)"}]

			//var crashesWithVersions = crashes.map(c => {c["versions"] = cc.getCrashDetailsSync(c.hash).sessionCountsByVersion; return c});
//			c => {c["versions"] = cc.getCrashDetailsSync(c.hash).sessionCountsByVersion; return c});

			function wrapper(c,cb) {
				console.log(c.name);
				cc.getCrashDetails(c.hash,function(err, result){
					if(err) cb(err);
					if(!result) {
						console.log("result came back as " +result);
						console.log("why?!");
						process.exit(1);
					}
					c["versions"] = result.sessionCountsByVersion;
					//sleep.sleep(30);
					cb(null, c);
				});
			}

//			async.mapSeries(crashes, wrapper, function(err, crashesWithVersions) {
//				if(err) callback(err);
				
				var crashesWithVersions = [{"status":"unresolved","displayReason":null,"hash":"575bf866f45e0e66","firstOccurred":"2016-07-07T12:57:18+00:00","lastOccurred":"2016-07-07T16:15:15+00:00","sessionCount":2,"reason":"GoogleApiClient must not be null","name":"java.lang.NullPointerException","uniqueSessionCount":2,"isSymbolized":"true","suspectLine":"com.google.android.gms.common.internal.zzaa.zzb(Unknown Source)","versions":{"4.5.718":2}},{"status":"unresolved","displayReason":null,"hash":"ed60dd981d4c6249","firstOccurred":"2016-07-07T16:23:51+00:00","lastOccurred":"2016-07-07T16:23:51+00:00","sessionCount":1,"reason":"","name":"java.lang.NoSuchFieldException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.fasterxml.jackson.databind.introspect.AnnotatedClass.resolveClassAnnotations(AnnotatedClass.java:316)","versions":{"4.5.718":1,"4.5.702":1}},{"status":"unresolved","displayReason":null,"hash":"eada72e7386eb9cb","firstOccurred":"2016-07-07T16:46:36+00:00","lastOccurred":"2016-07-07T16:46:36+00:00","sessionCount":1,"reason":"length=4; index=-369801955","name":"java.lang.ArrayIndexOutOfBoundsException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.guardian.http.cache.FileManager.addFileToTransactionList(FileManager.java:95)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"5570d256b2f81a59","firstOccurred":"2016-07-07T18:16:08+00:00","lastOccurred":"2016-07-07T18:16:08+00:00","sessionCount":1,"reason":"Fatal Exception thrown on Scheduler.Worker thread.","name":"java.lang.OutOfMemoryError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:54)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"c01bcc5fc57c0ce4","firstOccurred":"2016-07-07T19:14:28+00:00","lastOccurred":"2016-07-07T19:14:28+00:00","sessionCount":1,"reason":"","name":"java.lang.OutOfMemoryError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"org.jsoup.nodes.Document$OutputSettings.<init>(Document.java:373)","versions":{"4.5.718":1,"4.5.702":2}},{"status":"unresolved","displayReason":null,"hash":"fe0df9cc4691aa93","firstOccurred":"2016-07-07T19:56:50+00:00","lastOccurred":"2016-07-07T19:56:50+00:00","sessionCount":1,"reason":"Exception thrown on Scheduler.Worker thread. Add `onError` handling.","name":"java.lang.NoSuchMethodException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:52)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"258c4eb5d6e8a8ac","firstOccurred":"2016-07-07T21:49:22+00:00","lastOccurred":"2016-07-07T21:50:10+00:00","sessionCount":2,"reason":"input == null","name":"java.lang.NullPointerException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"org.apache.commons.codec.digest.DigestUtils.sha(DigestUtils.java:237)","versions":{"4.5.718":2}},{"status":"unresolved","displayReason":null,"hash":"78cd10157be73416","firstOccurred":"2016-07-07T22:07:22+00:00","lastOccurred":"2016-07-07T22:07:22+00:00","sessionCount":1,"reason":"pthread_create (1040KB stack) failed: Out of memory","name":"java.lang.OutOfMemoryError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"rx.internal.schedulers.NewThreadWorker.scheduleActual(NewThreadWorker.java:169)","versions":{"4.5.718":1,"4.5.702":1}},{"status":"unresolved","displayReason":null,"hash":"4a55a21359f365b1","firstOccurred":"2016-07-07T23:01:52+00:00","lastOccurred":"2016-07-07T23:01:52+00:00","sessionCount":1,"reason":"Package manager has died","name":"android.os.DeadObjectException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":null,"versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"795aad742f1fb7de","firstOccurred":"2016-07-07T23:06:44+00:00","lastOccurred":"2016-07-07T23:07:58+00:00","sessionCount":4,"reason":"Unable to instantiate service com.guardian.personalisation.savedpages.SavedPageMigrationService: java.lang.ClassNotFoundException: Didn't...","name":"java.lang.ClassNotFoundException","uniqueSessionCount":2,"isSymbolized":"true","suspectLine":null,"versions":{"4.5.718":4,"4.5.702":4}},{"status":"unresolved","displayReason":null,"hash":"d929dc286b587143","firstOccurred":"2016-07-07T23:08:50+00:00","lastOccurred":"2016-07-07T23:08:50+00:00","sessionCount":1,"reason":"Fatal Exception thrown on Scheduler.Worker thread.","name":"java.net.SocketTimeoutException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:54)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"1cb3d8c24c63fe38","firstOccurred":"2016-07-07T23:19:52+00:00","lastOccurred":"2016-07-07T23:19:52+00:00","sessionCount":1,"reason":"Unable to add window -- token android.os.BinderProxy@3e4d1f7b is not valid; is your activity running?","name":"android.view.WindowManager$BadTokenException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.facebook.internal.WebDialog$DialogWebViewClient.onPageStarted(WebDialog.java:513)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"b3657215c643df93","firstOccurred":"2016-07-07T23:22:27+00:00","lastOccurred":"2016-07-07T23:31:28+00:00","sessionCount":2,"reason":"","name":"java.lang.NullPointerException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":null,"versions":{"4.5.718":2,"4.5.702":2}},{"status":"unresolved","displayReason":null,"hash":"f988220f78c657c7","firstOccurred":"2016-07-07T23:51:30+00:00","lastOccurred":"2016-07-07T23:51:30+00:00","sessionCount":1,"reason":"","name":"java.util.ConcurrentModificationException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.guardian.personalisation.savedpages.SavedPageHelper.getSavedCards(SavedPageHelper.java:102)","versions":{"4.5.718":1,"4.5.702":2}},{"status":"unresolved","displayReason":null,"hash":"65795d89fcc225ef","firstOccurred":"2016-07-08T01:23:49+00:00","lastOccurred":"2016-07-08T01:23:49+00:00","sessionCount":1,"reason":"","name":"java.util.ConcurrentModificationException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.guardian.personalisation.savedpages.SavedPageHelper.getSavedCards(SavedPageHelper.java:102)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"ed0621a2d8547017","firstOccurred":"2016-07-08T02:18:04+00:00","lastOccurred":"2016-07-08T02:18:04+00:00","sessionCount":1,"reason":"Attempt to invoke virtual method 'void com.comscore.utils.Storage.add(java.lang.String, long)' on a null object reference","name":"java.lang.NullPointerException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.comscore.utils.task.a.run(Unknown Source)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"15c8e197bf09ffa7","firstOccurred":"2016-07-08T02:51:57+00:00","lastOccurred":"2016-07-08T02:51:57+00:00","sessionCount":1,"reason":"Fatal Exception thrown on Scheduler.Worker thread.","name":"java.util.ConcurrentModificationException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:54)","versions":{"4.5.718":1,"4.5.702":4}},{"status":"unresolved","displayReason":null,"hash":"d80b410414cb01b6","firstOccurred":"2016-07-08T03:37:39+00:00","lastOccurred":"2016-07-08T03:37:39+00:00","sessionCount":1,"reason":"Couldn't find com.fasterxml.jackson.annotation.JsonProperty.value","name":"java.lang.IncompatibleClassChangeError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.fasterxml.jackson.databind.introspect.AnnotatedClass._constructConstructor(AnnotatedClass.java:769)","versions":{"4.5.718":1,"4.5.702":3}},{"status":"unresolved","displayReason":null,"hash":"5dcadf08cfa1de65","firstOccurred":"2016-07-08T04:29:52+00:00","lastOccurred":"2016-07-08T04:29:52+00:00","sessionCount":1,"reason":"Unable to resume activity {com.guardian/com.guardian.ui.activities.ArticleActivity}: java.lang.IllegalArgumentException: Object already r...","name":"java.lang.IllegalArgumentException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":null,"versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"f33f26f031da7eb6","firstOccurred":"2016-07-08T04:30:03+00:00","lastOccurred":"2016-07-08T04:30:03+00:00","sessionCount":1,"reason":"Couldn't find com.fasterxml.jackson.annotation.JsonProperty.value","name":"java.lang.IncompatibleClassChangeError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.fasterxml.jackson.databind.introspect.AnnotatedClass._constructConstructor(AnnotatedClass.java:769)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"d541aa7c93318fce","firstOccurred":"2016-07-08T05:05:49+00:00","lastOccurred":"2016-07-08T05:05:49+00:00","sessionCount":1,"reason":"Parcelable encountered IOException writing serializable object (name = com.guardian.data.content.item.ArticleItem)","name":"java.io.InvalidClassException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"android.support.v4.app.TaskStackBuilderHoneycomb.getActivitiesPendingIntent(TaskStackBuilderHoneycomb.java:29)","versions":{"4.5.718":1,"4.5.702":3}},{"status":"unresolved","displayReason":null,"hash":"ede7060c1436cd79","firstOccurred":"2016-07-08T05:36:07+00:00","lastOccurred":"2016-07-08T05:36:07+00:00","sessionCount":1,"reason":"","name":"java.lang.OutOfMemoryError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"org.jsoup.nodes.Document$OutputSettings.<init>(Document.java:373)","versions":{"4.5.718":1,"4.5.702":1}},{"status":"unresolved","displayReason":null,"hash":"f0b6782da1273df9","firstOccurred":"2016-07-07T23:35:20+00:00","lastOccurred":"2016-07-08T05:36:16+00:00","sessionCount":4,"reason":"Argument is null","name":"java.lang.IllegalArgumentException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.outbrain.OBSDK.HttpClient.WebkitCookieManagerProxy.get(WebkitCookieManagerProxy.java:62)","versions":{"4.5.718":4}},{"status":"unresolved","displayReason":null,"hash":"c0148dd3d1cf0639","firstOccurred":"2016-07-08T05:44:16+00:00","lastOccurred":"2016-07-08T05:44:16+00:00","sessionCount":1,"reason":"","name":"java.lang.OutOfMemoryError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.guardian.http.cache.JournalSyncManager.processDirectory(JournalSyncManager.java:24)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"6733f2a7e00bdcc1","firstOccurred":"2016-07-08T05:56:44+00:00","lastOccurred":"2016-07-08T05:56:44+00:00","sessionCount":1,"reason":"","name":"java.lang.OutOfMemoryError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"okio.Buffer.readByteArray(Buffer.java:756)","versions":{"4.5.718":1,"4.5.702":1}},{"status":"unresolved","displayReason":null,"hash":"257077c1b6f5580f","firstOccurred":"2016-07-08T05:56:58+00:00","lastOccurred":"2016-07-08T05:56:58+00:00","sessionCount":1,"reason":"Couldn't find com.fasterxml.jackson.annotation.JsonProperty.value","name":"java.lang.IncompatibleClassChangeError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.fasterxml.jackson.databind.introspect.AnnotatedClass._constructConstructor(AnnotatedClass.java:769)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"b0d0cbf93a0547bc","firstOccurred":"2016-07-08T05:58:28+00:00","lastOccurred":"2016-07-08T05:58:28+00:00","sessionCount":1,"reason":"Parcelable encountered IOException writing serializable object (name = com.guardian.data.content.item.ArticleItem)","name":"java.io.InvalidClassException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"android.support.v4.app.TaskStackBuilderHoneycomb.getActivitiesPendingIntent(TaskStackBuilderHoneycomb.java:29)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"10b602c586d97b0c","firstOccurred":"2016-07-08T06:24:51+00:00","lastOccurred":"2016-07-08T06:24:51+00:00","sessionCount":1,"reason":"Resource ID #0x1060067","name":"android.content.res.Resources$NotFoundException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"android.support.v4.app.NotificationCompatApi21$Builder.build(NotificationCompatApi21.java:120)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"cbbe314d6e89f6a6","firstOccurred":"2016-07-08T06:31:52+00:00","lastOccurred":"2016-07-08T06:31:52+00:00","sessionCount":1,"reason":"Package manager has died","name":"android.os.TransactionTooLargeException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.adjust.sdk.DeviceInfo.getAppVersion(DeviceInfo.java:101)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"090460ba9ec97752","firstOccurred":"2016-07-08T06:36:41+00:00","lastOccurred":"2016-07-08T06:36:41+00:00","sessionCount":1,"reason":"Attempt to invoke virtual method 'byte[] java.lang.String.getBytes()' on a null object reference","name":"java.lang.NullPointerException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.google.firebase.iid.zzg.zzeH(Unknown Source)","versions":{"4.5.718":1,"4.5.702":4}},{"status":"unresolved","displayReason":null,"hash":"78d9b8fa1f21b61f","firstOccurred":"2016-07-07T22:07:28+00:00","lastOccurred":"2016-07-08T07:04:22+00:00","sessionCount":2,"reason":"Couldn't find com.fasterxml.jackson.annotation.JsonProperty.value","name":"java.lang.IncompatibleClassChangeError","uniqueSessionCount":2,"isSymbolized":"true","suspectLine":"com.fasterxml.jackson.databind.introspect.AnnotatedClass._constructConstructor(AnnotatedClass.java:769)","versions":{"4.5.718":2,"4.5.711":1,"4.5.702":11}},{"status":"unresolved","displayReason":null,"hash":"4a2399a815028bb9","firstOccurred":"2016-07-08T04:38:41+00:00","lastOccurred":"2016-07-08T07:08:04+00:00","sessionCount":3,"reason":"Parcelable encountered IOException writing serializable object (name = com.guardian.data.content.item.ArticleItem)","name":"java.io.InvalidClassException","uniqueSessionCount":3,"isSymbolized":"true","suspectLine":"android.support.v4.app.TaskStackBuilderHoneycomb.getActivitiesPendingIntent(TaskStackBuilderHoneycomb.java:29)","versions":{"4.5.718":3,"4.5.702":9}},{"status":"unresolved","displayReason":null,"hash":"7b9b4fa58cbf5bb4","firstOccurred":"2016-07-07T18:41:09+00:00","lastOccurred":"2016-07-08T07:29:37+00:00","sessionCount":2,"reason":"Fatal Exception thrown on Scheduler.Worker thread.","name":"java.util.ConcurrentModificationException","uniqueSessionCount":2,"isSymbolized":"true","suspectLine":"rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:54)","versions":{"4.5.718":2,"4.5.711":1,"4.5.702":12}},{"status":"unresolved","displayReason":null,"hash":"9053608fd3fe44fb","firstOccurred":"2016-07-08T07:45:01+00:00","lastOccurred":"2016-07-08T07:45:01+00:00","sessionCount":1,"reason":"The content of the adapter has changed but ListView did not receive a notification. Make sure the content of your adapter is not modified...","name":"java.lang.IllegalStateException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.guardian.ui.activities.HomeActivity.dispatchTouchEvent(HomeActivity.java:1253)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"9e41ef5c4784975d","firstOccurred":"2016-07-08T08:01:00+00:00","lastOccurred":"2016-07-08T08:01:00+00:00","sessionCount":1,"reason":"","name":"java.lang.IllegalStateException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":null,"versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"3502212fe107bb25","firstOccurred":"2016-07-08T08:56:53+00:00","lastOccurred":"2016-07-08T08:56:53+00:00","sessionCount":1,"reason":"Unable to resume activity {com.guardian/com.guardian.ui.activities.HomeActivity}: java.lang.SecurityException: Unable to start service In...","name":"java.lang.SecurityException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":null,"versions":{"4.5.718":1,"4.5.702":1}},{"status":"unresolved","displayReason":null,"hash":"f2502f3b16e12544","firstOccurred":"2016-07-08T09:06:07+00:00","lastOccurred":"2016-07-08T09:06:07+00:00","sessionCount":1,"reason":"Unable to create application com.guardian.GuardianApplication: java.lang.RuntimeException: Package manager has died","name":"android.os.DeadObjectException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":null,"versions":{"4.5.718":1,"4.5.711":1,"4.5.702":2}},{"status":"unresolved","displayReason":null,"hash":"93ef647c0f00fe75","firstOccurred":"2016-07-08T09:07:14+00:00","lastOccurred":"2016-07-08T09:07:14+00:00","sessionCount":1,"reason":"Fatal Exception thrown on Scheduler.Worker thread.","name":"java.lang.OutOfMemoryError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:54)","versions":{"4.5.718":1,"4.5.702":2}},{"status":"unresolved","displayReason":null,"hash":"847ecef1b2f561bb","firstOccurred":"2016-07-08T09:10:29+00:00","lastOccurred":"2016-07-08T09:10:29+00:00","sessionCount":1,"reason":"Fatal Exception thrown on Scheduler.Worker thread.","name":"java.lang.VerifyError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:54)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"6dca044e191769f6","firstOccurred":"2016-07-08T09:45:16+00:00","lastOccurred":"2016-07-08T09:45:16+00:00","sessionCount":1,"reason":"Fatal Exception thrown on Scheduler.Worker thread.","name":"java.util.ConcurrentModificationException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:54)","versions":{"4.5.718":1,"4.5.702":8}},{"status":"unresolved","displayReason":null,"hash":"5caffd87879482fa","firstOccurred":"2016-07-08T09:49:41+00:00","lastOccurred":"2016-07-08T09:49:41+00:00","sessionCount":1,"reason":"","name":"java.lang.OutOfMemoryError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"android.support.v4.app.Fragment$SavedState.writeToParcel(Fragment.java:343)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"9b4bbca4c75495aa","firstOccurred":"2016-07-08T09:53:19+00:00","lastOccurred":"2016-07-08T09:53:19+00:00","sessionCount":1,"reason":"crittercism.android.v.finalize() timed out after 10 seconds","name":"java.util.concurrent.TimeoutException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":null,"versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"25cec66bcb331237","firstOccurred":"2016-07-08T09:52:43+00:00","lastOccurred":"2016-07-08T10:12:41+00:00","sessionCount":2,"reason":"Couldn't find com.fasterxml.jackson.annotation.JsonSubTypes.value","name":"java.lang.IncompatibleClassChangeError","uniqueSessionCount":2,"isSymbolized":"true","suspectLine":"com.fasterxml.jackson.databind.introspect.AnnotatedClass.resolveClassAnnotations(AnnotatedClass.java:316)","versions":{"4.5.718":2,"4.5.702":4}},{"status":"unresolved","displayReason":null,"hash":"3796a817e5faa031","firstOccurred":"2016-07-08T10:23:55+00:00","lastOccurred":"2016-07-08T10:23:55+00:00","sessionCount":1,"reason":"Fatal Exception thrown on Scheduler.Worker thread.","name":"java.lang.OutOfMemoryError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:54)","versions":{"4.5.718":1,"4.5.702":3}},{"status":"unresolved","displayReason":null,"hash":"757ff94a6f23ba04","firstOccurred":"2016-07-07T15:04:21+00:00","lastOccurred":"2016-07-08T10:39:31+00:00","sessionCount":4,"reason":"GoogleApiClient must not be null","name":"java.lang.NullPointerException","uniqueSessionCount":4,"isSymbolized":"true","suspectLine":"com.google.android.gms.common.internal.zzaa.zzb(Unknown Source)","versions":{"4.5.718":4,"4.5.711":1}},{"status":"unresolved","displayReason":null,"hash":"a471d261f2229715","firstOccurred":"2016-07-08T10:44:34+00:00","lastOccurred":"2016-07-08T10:44:34+00:00","sessionCount":1,"reason":"Couldn't find com.fasterxml.jackson.annotation.JsonProperty.value","name":"java.lang.IncompatibleClassChangeError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.fasterxml.jackson.databind.introspect.AnnotatedClass._constructConstructor(AnnotatedClass.java:769)","versions":{"4.5.718":1,"4.5.702":1}},{"status":"unresolved","displayReason":null,"hash":"d9eb273e340c6bf4","firstOccurred":"2016-07-08T10:19:26+00:00","lastOccurred":"2016-07-08T10:44:51+00:00","sessionCount":2,"reason":"bad array lengths","name":"java.lang.RuntimeException","uniqueSessionCount":2,"isSymbolized":"true","suspectLine":"com.guardian.gcm.notifier.CustomNotifier.showThumbnailNotification(CustomNotifier.java:229)","versions":{"4.5.718":2,"4.5.702":2}},{"status":"unresolved","displayReason":null,"hash":"403e652f7fdb1563","firstOccurred":"2016-07-08T10:45:23+00:00","lastOccurred":"2016-07-08T10:45:23+00:00","sessionCount":1,"reason":"Attempt to invoke virtual method 'java.lang.annotation.Annotation com.fasterxml.jackson.databind.introspect.Annotated.getAnnotation(java....","name":"java.lang.NullPointerException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.fasterxml.jackson.databind.AnnotationIntrospector._findAnnotation(AnnotationIntrospector.java:1115)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"e9a3a08d98ff80df","firstOccurred":"2016-07-08T06:09:14+00:00","lastOccurred":"2016-07-08T10:49:24+00:00","sessionCount":5,"reason":"Couldn't find com.fasterxml.jackson.annotation.JsonSubTypes$Type.name","name":"java.lang.IncompatibleClassChangeError","uniqueSessionCount":5,"isSymbolized":"true","suspectLine":"com.fasterxml.jackson.databind.introspect.AnnotatedClass.resolveClassAnnotations(AnnotatedClass.java:316)","versions":{"4.5.718":5,"4.5.702":12}},{"status":"unresolved","displayReason":null,"hash":"573f2fea5d2d54b0","firstOccurred":"2016-07-08T10:58:11+00:00","lastOccurred":"2016-07-08T10:58:11+00:00","sessionCount":1,"reason":"Error receiving broadcast Intent { act=android.intent.action.PACKAGE_REPLACED dat=package:com.google.android.youtube flg=0x4000010 (has e...","name":"android.os.DeadObjectException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":null,"versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"e227c5f445133b2c","firstOccurred":"2016-07-08T10:58:47+00:00","lastOccurred":"2016-07-08T10:58:47+00:00","sessionCount":1,"reason":"Couldn't find com.fasterxml.jackson.annotation.JsonProperty.value","name":"java.lang.IncompatibleClassChangeError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.fasterxml.jackson.databind.introspect.AnnotatedClass._constructConstructor(AnnotatedClass.java:769)","versions":{"4.5.718":1,"4.5.702":8}},{"status":"unresolved","displayReason":null,"hash":"1091eacc34334fc3","firstOccurred":"2016-07-08T11:23:04+00:00","lastOccurred":"2016-07-08T11:23:04+00:00","sessionCount":1,"reason":"Unable to add window -- token null is not valid; is your activity running?","name":"android.view.WindowManager$BadTokenException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":null,"versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"730c773d59ca5ac4","firstOccurred":"2016-07-08T11:49:31+00:00","lastOccurred":"2016-07-08T11:49:31+00:00","sessionCount":1,"reason":"bad array lengths","name":"java.lang.RuntimeException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.guardian.gcm.notifier.CustomNotifier.showBigImageNotification(CustomNotifier.java:213)","versions":{"4.5.718":1,"4.5.702":4}},{"status":"unresolved","displayReason":null,"hash":"34b765c53c7f7a9a","firstOccurred":"2016-07-08T05:51:53+00:00","lastOccurred":"2016-07-08T11:57:24+00:00","sessionCount":4,"reason":"Couldn't find com.fasterxml.jackson.annotation.JsonProperty.value","name":"java.lang.IncompatibleClassChangeError","uniqueSessionCount":4,"isSymbolized":"true","suspectLine":"com.fasterxml.jackson.databind.introspect.AnnotatedClass._constructConstructor(AnnotatedClass.java:769)","versions":{"4.5.718":4,"4.5.702":9}},{"status":"unresolved","displayReason":null,"hash":"6154cca17f6c43b7","firstOccurred":"2016-07-08T12:14:11+00:00","lastOccurred":"2016-07-08T12:14:11+00:00","sessionCount":1,"reason":"Can not perform this action after onSaveInstanceState","name":"java.lang.IllegalStateException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"android.support.v4.app.FragmentManagerImpl.checkStateLoss(FragmentManager.java:1493)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"17d69c95e47ce274","firstOccurred":"2016-07-07T23:50:12+00:00","lastOccurred":"2016-07-08T13:10:00+00:00","sessionCount":5,"reason":"Couldn't find com.fasterxml.jackson.annotation.JsonSubTypes$Type.value","name":"java.lang.IncompatibleClassChangeError","uniqueSessionCount":5,"isSymbolized":"true","suspectLine":"com.fasterxml.jackson.databind.introspect.AnnotatedClass.resolveClassAnnotations(AnnotatedClass.java:316)","versions":{"4.5.718":5,"4.5.702":18}},{"status":"unresolved","displayReason":null,"hash":"df98ade8e971f85c","firstOccurred":"2016-07-08T13:13:49+00:00","lastOccurred":"2016-07-08T13:13:49+00:00","sessionCount":1,"reason":"No user for account type: uk.co.guardian.auth","name":"com.guardian.login.account.UserNotLoggedInException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.guardian.login.account.GuardianAccount.getName(GuardianAccount.java:46)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"f20832387ff7390d","firstOccurred":"2016-07-07T13:23:19+00:00","lastOccurred":"2016-07-08T13:35:05+00:00","sessionCount":4,"reason":"Fatal Exception thrown on Scheduler.Worker thread.","name":"java.lang.OutOfMemoryError","uniqueSessionCount":4,"isSymbolized":"true","suspectLine":"rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:54)","versions":{"4.5.718":4,"4.5.711":1,"4.5.702":15}},{"status":"unresolved","displayReason":null,"hash":"b5eca07d0bc57c99","firstOccurred":"2016-07-08T13:37:50+00:00","lastOccurred":"2016-07-08T13:37:50+00:00","sessionCount":1,"reason":"","name":"java.util.ConcurrentModificationException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.guardian.personalisation.savedpages.SavedPageHelper.getSavedCards(SavedPageHelper.java:102)","versions":{"4.5.718":1,"4.5.702":2}},{"status":"unresolved","displayReason":null,"hash":"c5565bfe2f513448","firstOccurred":"2016-07-08T13:42:33+00:00","lastOccurred":"2016-07-08T13:42:33+00:00","sessionCount":1,"reason":"Fatal Exception thrown on Scheduler.Worker thread.","name":"java.lang.OutOfMemoryError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:54)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"d0d41e2326912e11","firstOccurred":"2016-07-07T15:23:38+00:00","lastOccurred":"2016-07-08T13:49:09+00:00","sessionCount":10,"reason":"Couldn't find com.fasterxml.jackson.annotation.JsonProperty.value","name":"java.lang.IncompatibleClassChangeError","uniqueSessionCount":10,"isSymbolized":"true","suspectLine":"com.fasterxml.jackson.databind.introspect.AnnotatedClass._constructConstructor(AnnotatedClass.java:769)","versions":{"4.5.718":10,"4.5.702":35}},{"status":"unresolved","displayReason":null,"hash":"6ca50b47d412492c","firstOccurred":"2016-07-07T20:00:41+00:00","lastOccurred":"2016-07-08T14:06:58+00:00","sessionCount":6,"reason":"android.os.DeadObjectException","name":"android.os.DeadObjectException","uniqueSessionCount":6,"isSymbolized":"true","suspectLine":"com.google.android.gms.common.zze.zzk(Unknown Source)","versions":{"4.5.718":6,"4.5.702":14}},{"status":"unresolved","displayReason":null,"hash":"c94a126cd1fdc9fb","firstOccurred":"2016-07-08T14:11:15+00:00","lastOccurred":"2016-07-08T14:11:15+00:00","sessionCount":1,"reason":"Can not perform this action after onSaveInstanceState","name":"java.lang.IllegalStateException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"android.support.v4.app.FragmentManagerImpl.checkStateLoss(FragmentManager.java:1493)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"1fa5cc24a5c87575","firstOccurred":"2016-07-08T08:03:02+00:00","lastOccurred":"2016-07-08T14:23:12+00:00","sessionCount":2,"reason":"Couldn't find com.fasterxml.jackson.databind.annotation.JsonDeserialize.using","name":"java.lang.IncompatibleClassChangeError","uniqueSessionCount":2,"isSymbolized":"true","suspectLine":"com.fasterxml.jackson.databind.introspect.AnnotatedClass.resolveClassAnnotations(AnnotatedClass.java:310)","versions":{"4.5.718":2,"4.5.702":2}},{"status":"unresolved","displayReason":null,"hash":"c0acc026edb75a09","firstOccurred":"2016-07-08T05:19:55+00:00","lastOccurred":"2016-07-08T14:25:25+00:00","sessionCount":4,"reason":"GoogleApiClient must not be null","name":"java.lang.NullPointerException","uniqueSessionCount":4,"isSymbolized":"true","suspectLine":"com.google.android.gms.common.internal.zzaa.zzb(Unknown Source)","versions":{"4.5.718":4}},{"status":"unresolved","displayReason":null,"hash":"1db951bb8e657a6d","firstOccurred":"2016-07-08T08:04:47+00:00","lastOccurred":"2016-07-08T14:29:23+00:00","sessionCount":2,"reason":"Parcelable encountered IOException writing serializable object (name = com.guardian.data.content.item.ArticleItem)","name":"java.io.InvalidClassException","uniqueSessionCount":2,"isSymbolized":"true","suspectLine":"android.support.v4.app.TaskStackBuilderHoneycomb.getActivitiesPendingIntent(TaskStackBuilderHoneycomb.java:29)","versions":{"4.5.718":2,"4.5.702":5}},{"status":"unresolved","displayReason":null,"hash":"f75b76f84bca1b85","firstOccurred":"2016-07-07T21:42:50+00:00","lastOccurred":"2016-07-08T14:40:23+00:00","sessionCount":2,"reason":"Fatal Exception thrown on Scheduler.Worker thread.","name":"java.lang.OutOfMemoryError","uniqueSessionCount":2,"isSymbolized":"true","suspectLine":"rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:54)","versions":{"4.5.718":2,"4.5.711":1,"4.5.702":3}},{"status":"unresolved","displayReason":null,"hash":"e9e72c5036413cf4","firstOccurred":"2016-07-07T20:36:36+00:00","lastOccurred":"2016-07-08T14:42:29+00:00","sessionCount":25,"reason":"","name":"java.lang.NullPointerException","uniqueSessionCount":5,"isSymbolized":"true","suspectLine":"android.support.v4.app.FragmentActivity.startActivityForResult(FragmentActivity.java:842)","versions":{"4.5.718":25,"4.5.702":313}},{"status":"unresolved","displayReason":null,"hash":"4a5e2434178205d6","firstOccurred":"2016-07-08T08:08:43+00:00","lastOccurred":"2016-07-08T14:43:06+00:00","sessionCount":5,"reason":"Fatal Exception thrown on Scheduler.Worker thread.","name":"java.lang.OutOfMemoryError","uniqueSessionCount":5,"isSymbolized":"true","suspectLine":"rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:54)","versions":{"4.5.718":5,"4.5.702":6}},{"status":"unresolved","displayReason":null,"hash":"e7ce809c78d6ad86","firstOccurred":"2016-07-08T02:25:54+00:00","lastOccurred":"2016-07-08T14:50:18+00:00","sessionCount":31,"reason":"","name":"java.lang.OutOfMemoryError","uniqueSessionCount":28,"isSymbolized":"true","suspectLine":"com.squareup.picasso.BitmapHunter.decodeStream(BitmapHunter.java:142)","versions":{"4.5.718":31,"4.5.711":2,"4.5.702":153}},{"status":"unresolved","displayReason":null,"hash":"189ce493f36b56b0","firstOccurred":"2016-07-08T11:45:40+00:00","lastOccurred":"2016-07-08T14:52:57+00:00","sessionCount":3,"reason":"android.os.DeadObjectException","name":"android.os.DeadObjectException","uniqueSessionCount":3,"isSymbolized":"true","suspectLine":"com.google.android.gms.common.zze.zzk(Unknown Source)","versions":{"4.5.718":3,"4.5.702":3}},{"status":"unresolved","displayReason":null,"hash":"b005eefdfca9e726","firstOccurred":"2016-07-08T15:04:41+00:00","lastOccurred":"2016-07-08T15:04:41+00:00","sessionCount":1,"reason":"Fatal Exception thrown on Scheduler.Worker thread.","name":"java.lang.OutOfMemoryError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:54)","versions":{"4.5.718":1,"4.5.702":3}},{"status":"unresolved","displayReason":null,"hash":"de1215687b83e259","firstOccurred":"2016-07-08T15:18:27+00:00","lastOccurred":"2016-07-08T15:18:27+00:00","sessionCount":1,"reason":"IabHelper was disposed of, so it cannot be used.","name":"java.lang.IllegalStateException","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.guardian.subs.util.IabHelper.checkNotDisposed(IabHelper.java:364)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"5a58d3047c59e95d","firstOccurred":"2016-07-08T09:39:30+00:00","lastOccurred":"2016-07-08T15:19:37+00:00","sessionCount":4,"reason":"Couldn't find com.fasterxml.jackson.annotation.JsonProperty.value","name":"java.lang.IncompatibleClassChangeError","uniqueSessionCount":4,"isSymbolized":"true","suspectLine":"com.fasterxml.jackson.databind.introspect.AnnotatedClass._constructConstructor(AnnotatedClass.java:769)","versions":{"4.5.718":4,"4.5.702":8}},{"status":"unresolved","displayReason":null,"hash":"8f0c4976d935c648","firstOccurred":"2016-07-08T11:49:08+00:00","lastOccurred":"2016-07-08T15:21:39+00:00","sessionCount":5,"reason":"","name":"java.lang.OutOfMemoryError","uniqueSessionCount":5,"isSymbolized":"true","suspectLine":"com.squareup.picasso.BitmapHunter.decodeStream(BitmapHunter.java:142)","versions":{"4.5.718":5,"4.5.702":10}},{"status":"unresolved","displayReason":null,"hash":"72a3d961cf315d57","firstOccurred":"2016-07-08T15:54:33+00:00","lastOccurred":"2016-07-08T15:54:33+00:00","sessionCount":1,"reason":"Unable to start activity ComponentInfo{com.guardian/com.guardian.ui.activities.WebViewActivity}: android.view.InflateException: Binary XM...","name":"java.lang.UnsatisfiedLinkError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":null,"versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"0a485e8edd4ac025","firstOccurred":"2016-07-08T15:57:00+00:00","lastOccurred":"2016-07-08T15:57:00+00:00","sessionCount":1,"reason":"Method getAlpnSelectedProtocol not supported for object SSL socket over Socket[address=media.guim.co.uk/151.101.60.67,port=443,localPort=...","name":"java.lang.AssertionError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.squareup.okhttp.internal.OptionalMethod.invoke(OptionalMethod.java:109)","versions":{"4.5.718":1}},{"status":"unresolved","displayReason":null,"hash":"1f7e1037e8f18cc3","firstOccurred":"2016-07-08T10:36:18+00:00","lastOccurred":"2016-07-08T16:13:37+00:00","sessionCount":2,"reason":"Attempt to invoke virtual method 'boolean android.content.Intent.migrateExtraStreamToClipData()' on a null object reference","name":"java.lang.NullPointerException","uniqueSessionCount":2,"isSymbolized":"true","suspectLine":"android.support.v4.app.FragmentActivity.startActivityForResult(FragmentActivity.java:842)","versions":{"4.5.718":2,"4.5.702":291}},{"status":"unresolved","displayReason":null,"hash":"52854bc4050d025d","firstOccurred":"2016-07-08T07:24:03+00:00","lastOccurred":"2016-07-08T16:29:51+00:00","sessionCount":5,"reason":"Attempt to invoke virtual method 'void android.graphics.drawable.ScaleDrawable.setColorFilter(int, android.graphics.PorterDuff$Mode)' on ...","name":"java.lang.NullPointerException","uniqueSessionCount":2,"isSymbolized":"true","suspectLine":"com.guardian.ui.views.cards.AudioCardView.setColours(AudioCardView.java:96)","versions":{"4.5.718":5,"4.5.702":6}},{"status":"unresolved","displayReason":null,"hash":"437ea8b48c9b0cd1","firstOccurred":"2016-07-08T16:34:56+00:00","lastOccurred":"2016-07-08T16:34:56+00:00","sessionCount":1,"reason":"pthread_create (1040KB stack) failed: Try again","name":"java.lang.OutOfMemoryError","uniqueSessionCount":1,"isSymbolized":"true","suspectLine":"com.google.android.gms.measurement.internal.zzw.zza(Unknown Source)","versions":{"4.5.718":1,"4.5.702":4}},{"status":"unresolved","displayReason":null,"hash":"0723330e813d6bd9","firstOccurred":"2016-07-08T11:49:28+00:00","lastOccurred":"2016-07-08T16:43:43+00:00","sessionCount":2,"reason":"","name":"java.lang.OutOfMemoryError","uniqueSessionCount":2,"isSymbolized":"true","suspectLine":"com.squareup.picasso.BitmapHunter.decodeStream(BitmapHunter.java:142)","versions":{"4.5.718":2,"4.5.711":1,"4.5.702":7}},{"status":"unresolved","displayReason":null,"hash":"838dbbd778af819a","firstOccurred":"2016-07-07T18:01:35+00:00","lastOccurred":"2016-07-08T16:56:31+00:00","sessionCount":8,"reason":"Fatal Exception thrown on Scheduler.Worker thread.","name":"java.lang.OutOfMemoryError","uniqueSessionCount":7,"isSymbolized":"true","suspectLine":"rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:54)","versions":{"4.5.718":8,"4.5.711":5,"4.5.702":30}},{"status":"unresolved","displayReason":null,"hash":"3421c75fcf6a4f1f","firstOccurred":"2016-07-07T21:43:44+00:00","lastOccurred":"2016-07-08T17:05:57+00:00","sessionCount":3,"reason":"Failed to allocate a 8204 byte allocation with 2294 free bytes and 2294B until OOM","name":"java.lang.OutOfMemoryError","uniqueSessionCount":3,"isSymbolized":"true","suspectLine":"okio.Segment.<init>(Segment.java:61)","versions":{"4.5.718":3,"4.5.702":3}},{"status":"unresolved","displayReason":null,"hash":"7d2deb6dc8932f84","firstOccurred":"2016-07-07T21:44:23+00:00","lastOccurred":"2016-07-08T17:07:34+00:00","sessionCount":22,"reason":"Failed to allocate a 31371720 byte allocation with 15595178 free bytes and 14MB until OOM","name":"java.lang.OutOfMemoryError","uniqueSessionCount":11,"isSymbolized":"true","suspectLine":"okio.Buffer.readByteArray(Buffer.java:756)","versions":{"4.5.718":22,"4.5.702":48}},{"status":"unresolved","displayReason":null,"hash":"5b68b5e6ef6167df","firstOccurred":"2016-07-07T23:44:40+00:00","lastOccurred":"2016-07-08T17:15:44+00:00","sessionCount":17,"reason":"Fatal Exception thrown on Scheduler.Worker thread.","name":"java.util.ConcurrentModificationException","uniqueSessionCount":9,"isSymbolized":"true","suspectLine":"rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:54)","versions":{"4.5.718":17,"4.5.711":3,"4.5.702":18}},{"status":"unresolved","displayReason":null,"hash":"2989b8d11e9a6583","firstOccurred":"2016-07-07T12:32:41+00:00","lastOccurred":"2016-07-08T17:16:53+00:00","sessionCount":21,"reason":"","name":"java.lang.OutOfMemoryError","uniqueSessionCount":21,"isSymbolized":"true","suspectLine":"com.squareup.picasso.BitmapHunter.decodeStream(BitmapHunter.java:142)","versions":{"4.5.718":21,"4.5.711":1,"4.5.702":61}},{"status":"unresolved","displayReason":null,"hash":"ea0b3f9e27855bf2","firstOccurred":"2016-07-07T23:26:10+00:00","lastOccurred":"2016-07-08T17:25:41+00:00","sessionCount":15,"reason":"","name":"java.lang.OutOfMemoryError","uniqueSessionCount":15,"isSymbolized":"true","suspectLine":"com.squareup.picasso.BitmapHunter.decodeStream(BitmapHunter.java:142)","versions":{"4.5.718":15,"4.5.702":58}},{"status":"unresolved","displayReason":null,"hash":"ea70aa4cdc4e8b2d","firstOccurred":"2016-07-08T11:45:41+00:00","lastOccurred":"2016-07-08T17:26:30+00:00","sessionCount":37,"reason":"","name":"java.lang.OutOfMemoryError","uniqueSessionCount":31,"isSymbolized":"true","suspectLine":"com.squareup.picasso.BitmapHunter.decodeStream(BitmapHunter.java:142)","versions":{"4.5.718":37,"4.5.711":1,"4.5.702":101}},{"status":"unresolved","displayReason":null,"hash":"1658365e91c83926","firstOccurred":"2016-07-07T20:52:25+00:00","lastOccurred":"2016-07-08T17:37:31+00:00","sessionCount":5,"reason":"GoogleApiClient must not be null","name":"java.lang.NullPointerException","uniqueSessionCount":4,"isSymbolized":"true","suspectLine":"com.google.android.gms.common.internal.zzaa.zzb(Unknown Source)","versions":{"4.5.718":5}},{"status":"unresolved","displayReason":null,"hash":"383528b0024cb90f","firstOccurred":"2016-07-08T12:45:35+00:00","lastOccurred":"2016-07-08T17:42:02+00:00","sessionCount":6,"reason":"com.guardian.data.content.item.UnknownItem cannot be cast to com.guardian.data.content.item.ArticleItem","name":"java.lang.ClassCastException","uniqueSessionCount":6,"isSymbolized":"true","suspectLine":"com.guardian.http.Mapper.parseItem(Mapper.java:147)","versions":{"4.5.718":6,"4.5.702":6}},{"status":"unresolved","displayReason":null,"hash":"14ab2d734d733dc4","firstOccurred":"2016-07-07T19:00:07+00:00","lastOccurred":"2016-07-08T18:02:44+00:00","sessionCount":23,"reason":"attempt to write a readonly database (code 776)","name":"android.database.sqlite.SQLiteReadOnlyDatabaseException","uniqueSessionCount":2,"isSymbolized":"true","suspectLine":"com.guardian.http.cache.CacheJournalDbHelper.getEntry(CacheJournalDbHelper.java:82)","versions":{"4.5.718":23,"4.5.702":20}}]

				crashesWithVersions = crashesWithVersions.filter(c => c.sessionCount > 1 && c.uniqueSessionCount > 1)

				    // results is now an array of stats for each file
				var newCrashes = crashesWithVersions.filter(c => Object.keys(c.versions).length == 1)
				console.log("New in " + appVersion);
				Util.print(newCrashes);
				var merged = mergeThem(newCrashes);
				console.log("**Merged " + appVersion);
				Util.print(merged)
			
				var newMajorVersionCrashes = crashesWithVersions.filter(c => { 
					var versions = Object.keys(c.versions)
					var versionsInterested = versions.filter(v => v.indexOf(majorVersion) > -1);
					return versionsInterested.length == versions.length;
				});
				
				
				console.log("New in " + majorVersion);
				Util.print(newMajorVersionCrashes);
				var merged2 = mergeThem(newMajorVersionCrashes);
				console.log("**Merged " + majorVersion);
				Util.print(merged2)

				callback(null, appVersion, majorVersion, merged, merged2);
			//});

		//});
//	});
};

function mergeThem(crashes) {
	function findMergedCrash(crash) {
		var filtered = merged.filter(c => ( c.name.includes(crash.name) && 
		                                    c.reason.includes(crash.reason)
		                                  ) || 
		                                  ( c.name.includes(crash.name) && 
		                                    c.suspectLine.includes(crash.suspectLine))
		                                  );
		return filtered[0]; //dodg
	}

	var merged = [];
	crashes.forEach(crash => {
		if(mergedCrash = findMergedCrash(crash)) {
			merged[0].sessionCount += crash.sessionCount;
			merged[0].uniqueSessionCount += crash.uniqueSessionCount;
		}
		else {
			merged.push(crash)
		}
	});

	return merged.sort( (a,b) => b.uniqueSessionCount - a.uniqueSessionCount );
}

function generateVersionSummary(system_version, app_version) {
	var androidVersion = crashOSVersionSummary(system_version)
	var appVersion = crashAppVersionSummary(app_version)
	Util.print(androidVersion);
	Util.print(appVersion);
	if(appVersion === "" && androidVersion === "")
		return ""
	else if (appVersion != "" && androidVersion != "")
		return `Exclusive to <b>${appVersion}</b> and <b>${androidVersion}</b>.`
	else if (appVersion != "" && androidVersion === "")
		return `Exclusive to <b>${appVersion}</b>.`
	else if (appVersion === "" && androidVersion !== "")
		return `Exclusive to <b>${androidVersion}</b>.`

}

function crashOSVersionSummary(os) {
	var versions = os.map(a => a[0]);
	var majorVersions = _.uniq(versions.map(a => a.slice(0,9)));

	if(majorVersions.length == 1)
		return majorVersions[0].charAt(0).toUpperCase() + majorVersions[0].slice(1);
	else
		return "";
}

function crashAppVersionSummary(app) {
	var versions = app.map(a => a[0]);

	if(versions.length == 1)
		return versions[0];
	else
		return "";
}

function mostWidespreadCrash(crashes) {
	return crashes.sort((b,a) => a.uniqueSessionCount - b.uniqueSessionCount)[0];
}

function mostFrequentCrash(crashes) {
	return crashes.sort((b,a) => a.sessionCount - b.sessionCount)[0];
}

function calculateHistogramFor(crashes) {
	var histogram = {}
	crashes.forEach(crash => {
		if(typeof histogram[crash.name] === "undefined")
			histogram[crash.name] = crash.sessionCount;
		else
			histogram[crash.name] += crash.sessionCount;
	})
	var sortedKeys = Object.keys(histogram).sort( (a,b) => histogram[b] - histogram[a] );
	sortedHistogram = {};
	sortedKeys.forEach(key => sortedHistogram[key] = histogram[key]);
	return sortedHistogram;
}
